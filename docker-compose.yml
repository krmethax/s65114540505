services:
  db:
    image: postgres:16
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
      - ./data-init:/docker-entrypoint-initdb.d
    networks:
      - backend

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: api
    restart: always
    environment:
      NODE_ENV: development
      PORT: 3001
      DB_HOST: db
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_NAME: ${DB_NAME}
      DB_PORT: 5432
    expose:
      - "3001"
    depends_on:
      db:
        condition: service_started
    networks:
      - backend
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.api.rule=PathPrefix(`/api`)'
      - 'traefik.http.routers.api.entrypoints=web'
      - 'traefik.http.routers.api.priority=200'
      - 'traefik.http.services.api.loadbalancer.server.port=3001'

  website:
    build:
      context: ./website
      dockerfile: Dockerfile
    container_name: website
    restart: always
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_BASE_URL: /api
    expose:
      - "3000"
    depends_on:
      api:
        condition: service_started
    networks:
      - backend
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.website.rule=PathPrefix(`/`)'
      - 'traefik.http.routers.website.entrypoints=web'
      - 'traefik.http.routers.website.priority=100'
      - 'traefik.http.services.website.loadbalancer.server.port=3000'

  traefik:
    image: traefik:3.0
    container_name: traefik
    restart: always
    ports:
      - '80:80'
    volumes:
      - ./traefix/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefix/acme.json:/acme.json
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - website
      - api
    networks:
      - backend
    labels:
      - 'traefik.enable=true'

networks:
  backend:
    driver: bridge
